<div class="checkout-form">
    <h2>Shipping Information</h2>

    @if (isLoggedIn && getSavedAddressKeys().length > 0) {
        <mat-form-field appearance="outline" class="full-width">
            <mat-label>Use Saved Address</mat-label>
            <mat-select [(value)]="selectedSavedAddress" (selectionChange)="onSavedAddressChange($event.value)">
                <mat-option value="">Enter New Address</mat-option>
                @for (nickname of getSavedAddressKeys(); track nickname) {
                    <mat-option [value]="nickname">{{ nickname }}</mat-option>
                }
            </mat-select>
        </mat-form-field>
    }

    <form [formGroup]="shippingForm">
        @if (!isLoggedIn) {
            <mat-form-field appearance="outline" class="full-width">
                <mat-label>Full Name</mat-label>
                <input matInput formControlName="name" required />
                @if (shippingForm.get('name')?.hasError('required') && shippingForm.get('name')?.touched) {
                    <mat-error>Name is required</mat-error>
                }
            </mat-form-field>
        }

        <mat-form-field appearance="outline" class="full-width">
            <mat-label>Street Address</mat-label>
            <input matInput formControlName="street" required />
            @if (shippingForm.get('street')?.hasError('required') && shippingForm.get('street')?.touched) {
                <mat-error>Street address is required</mat-error>
            }
        </mat-form-field>

        <div class="form-row">
            <mat-form-field appearance="outline">
                <mat-label>City</mat-label>
                <input matInput formControlName="city" required />
                @if (shippingForm.get('city')?.hasError('required') && shippingForm.get('city')?.touched) {
                    <mat-error>City is required</mat-error>
                }
            </mat-form-field>

            <mat-form-field appearance="outline">
                <mat-label>State</mat-label>
                <input matInput formControlName="state" required maxlength="2" />
                @if (shippingForm.get('state')?.hasError('required') && shippingForm.get('state')?.touched) {
                    <mat-error>State is required</mat-error>
                }
            </mat-form-field>
        </div>

        <div class="form-row">
            <mat-form-field appearance="outline">
                <mat-label>ZIP Code</mat-label>
                <input matInput formControlName="zip" required />
                @if (shippingForm.get('zip')?.hasError('required') && shippingForm.get('zip')?.touched) {
                    <mat-error>ZIP code is required</mat-error>
                }
            </mat-form-field>

            <mat-form-field appearance="outline">
                <mat-label>Country</mat-label>
                <input matInput formControlName="country" required />
                @if (shippingForm.get('country')?.hasError('required') && shippingForm.get('country')?.touched) {
                    <mat-error>Country is required</mat-error>
                }
            </mat-form-field>
        </div>

        @if (isLoggedIn && selectedSavedAddress === '') {
            <div class="save-address-section">
                <mat-checkbox [(ngModel)]="saveCurrentAddress" [ngModelOptions]="{standalone: true}">
                    Save this address for future orders
                </mat-checkbox>
                @if (saveCurrentAddress) {
                    <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Address Nickname (e.g., "Home", "Work")</mat-label>
                        <input matInput [(ngModel)]="addressNickname" [ngModelOptions]="{standalone: true}" placeholder="Home" />
                    </mat-form-field>
                }
            </div>
        }
    </form>

    <h2>Payment Information</h2>
    <div class="payment-section">
        <div id="card-element" class="card-element"></div>
        @if (cardError) {
            <div class="card-error">{{ cardError }}</div>
        }
    </div>
</div>
